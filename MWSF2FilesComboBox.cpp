// MWProgramsComboBox.cpp : implementation file
//

#include "stdafx.h"
#include "MidiGlassApp.h"
#include "MWSF2FilesComboBox.h"

#include <io.h>

#include "MidiGlassApp.h"

#include "strstr.h"

extern CMidiWorksApp	theApp;

#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
static char THIS_FILE[] = __FILE__;
#endif

IMPLEMENT_DYNAMIC(CMWSF2FilesComboBox, CMWComboBox)

//
///////////////////////////////////////////////////////////////////////////////////////////
// CMWSF2FilesComboBox
///////////////////////////////////////////////////////////////////////////////////////////
CMWSF2FilesComboBox::CMWSF2FilesComboBox()
{
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
CMWSF2FilesComboBox::~CMWSF2FilesComboBox()
{
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
BEGIN_MESSAGE_MAP(CMWSF2FilesComboBox, CMWComboBox)
	//{{AFX_MSG_MAP(CMWSF2FilesComboBox)
	ON_CONTROL_REFLECT(CBN_SELCHANGE, OnSelchange)
	ON_WM_CTLCOLOR()
	ON_WM_ERASEBKGND()
	//}}AFX_MSG_MAP
	ON_CONTROL_REFLECT(CBN_DROPDOWN, &CMWSF2FilesComboBox::OnCbnDropdown)
END_MESSAGE_MAP()

//
///////////////////////////////////////////////////////////////////////////////////////////
// CMWSF2FilesComboBox message handlers
//
///////////////////////////////////////////////////////////////////////////////////////////
void CMWSF2FilesComboBox::ReLoad()
{
	int iCurSel = GetCurSel();

	CMWComboBox::ResetContent ();

	//
	if ( theApp.m_bUse_Sound_Font )
	{
		char pathname [ MAX_PATH ];
		strcpy_s ( pathname, sizeof(pathname) , theApp.m_SoundFontFile );
		RemoveFileName ( pathname );
		strcat_s ( pathname, sizeof(pathname), "\\*.sf2" );

		struct _finddata_t fileinfo;
		ZeroMemory ( &fileinfo, sizeof(fileinfo) );
		intptr_t ptr = _findfirst (  pathname, &fileinfo );
		if ( ptr != -1 )
		{
			int iRes = 0;
			while ( iRes == 0 )
			{
				if ( ( fileinfo.attrib & _A_SUBDIR ) == 0  )
				{
					AddString ( fileinfo.name );
				}
				iRes = _findnext ( ptr, &fileinfo );
			}

			_findclose( ptr );
		}

		if ( iCurSel >= 0 && iCurSel < GetCount() )
		{
			SetCurSel ( iCurSel );
		}
	}
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
void CMWSF2FilesComboBox::ResetContent()
{
	SetAnsiVarFont ();

	ReLoad();
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
void CMWSF2FilesComboBox::OnSelchange() 
{
	CMWComboBox::OnSelchange();
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
void CMWSF2FilesComboBox::SetAnsiVarFont()
{
	CMWComboBox::SetAnsiVarFont();
}

//
///////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////
void CMWSF2FilesComboBox::SetAnsiFixedFont()
{
	CMWComboBox::SetAnsiFixedFont();
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
HBRUSH CMWSF2FilesComboBox::OnCtlColor(CDC* pDC, CWnd* pWnd, UINT nCtlColor) 
{
	HBRUSH hbr = CMWComboBox::OnCtlColor(pDC, pWnd, nCtlColor);
	
	// TODO
	HBRUSH hBrush = FriendCtlColor(pDC, pWnd, nCtlColor);
	if ( hBrush != NULL )
	{
		return hBrush;
	}

	// TODO
	return hbr;
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
BOOL CMWSF2FilesComboBox::OnEraseBkgnd(CDC* pDC) 
{
	// TODO
	BOOL bRes = FriendEraseBkgnd(this, pDC);
	if ( bRes )
	{
		return bRes;
	}

	return CMWComboBox::OnEraseBkgnd(pDC);
}

//
///////////////////////////////////////////////////////////////////////////////////////////
//
///////////////////////////////////////////////////////////////////////////////////////////
void CMWSF2FilesComboBox::OnCbnDropdown()
{
	// TODO
	ReLoad();
}
